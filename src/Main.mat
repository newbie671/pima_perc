#! /usr/bin/octave -qf

A = csvread("../data/pima-indians-diabetes.data");
n = columns(A);

#ones = A((A(:,n)==1),:);
zeroes = A((A(:,n)==0),:);

#for i = 1:n-1
#    figure;
#    plot(ones(:,i), ones(:,i+1), "rx");
#    hold on;
#    plot(zeroes(:,i), zeroes(:,i+1), "go");
#endfor

x = A(:,1:8);
y = A(:,9:9);

x(x(:,1) > 8) = 8;
max(x(:,8))
x(x(:,8) <=30) = 1;
x(x(:,8) > 30 & x(:,8) <= 40) = 2;
x(x(:,8) > 40 & x(:,8) <= 50) = 3;
x(x(:,8) > 50 & x(:,8) <= 60) = 4;
x(x(:,8) > 60 & x(:,8) <= 70) = 5;
x(x(:,8) > 70) = 6;
x -= repmat(mean(x), rows(x), 1);
x ./= repmat(var(x), rows(x), 1);

function [dIn, dOut, nData, weights] = init(in,out)
    dIn = columns(in);
    dOut = columns(out);
    nData = rows(out);
    weights = rand(dIn+1,dOut) * 0.1 - 0.05;
endfunction

function output = pcnfrwd(inputs, weights)
    output = ((inputs * weights) > 0);
endfunction

function weights = pcntrain(inputs, targets, weights, eta, nIterations)
    #add bias weights
    columns(inputs);
    inputs = [ones(rows(inputs),1),inputs];

    #used to rearrange training examples
    change = range(rows(inputs),1);
    for n = 1:nIterations
        outputs = pcnfrwd(inputs,weights);
        weights += eta * (inputs' * (targets - outputs));

        change = randperm(rows(inputs))';
        inputs = inputs(change,:);
        targets = targets(change,:);
    endfor
endfunction

function [cm,acc]= confmat(x, y, weights) 
    x = [ones(rows(x),1),x];
    nY = rows(unique(y));
    cm = zeros(nY, nY);
    outputs = pcnfrwd(x, weights);
    for i = 1:rows(x)
        cm(y(i) + 1,outputs(i) + 1)++;
    endfor
    acc = sum(diag(cm)) / sum(cm(:));
endfunction

[_,_,_,weights] = init(x,y);
weights = pcntrain(x,y,weights,0.25,100);
[m, a] = confmat(x, y, weights);

Accs = [];
for i = 1:10
    xTrain = x(1:2:end,:);
    xTest = x(2:2:end,:);
    yTrain = y(1:2:end,:);
    yTest = y(2:2:end,:);

    [_,_,_,weights] = init(xTrain, yTrain);
    weights = pcntrain(xTrain, yTrain, weights, 0.25, 100);
    [m, a] = confmat(xTest, yTest, weights);
    Accs = [Accs, a];
endfor

function acc = eval(Input, Output)
    [_,_,_,weights] = init(Input,Output);
    weights = pcntrain(Input,Output,weights,0.25,100);
    [_, acc] = confmat(Input, Output, weights);
endfunction

mean(Accs)

source('./SelectFeatures.mat');
for j = 1:50
    Accs = [];
    addpath(".");
    SelectedFeatures = SelectFeatures(x, y, "eval")
    xTrain = x(1:2:end, SelectedFeatures);
    xTest  = x(2:2:end, SelectedFeatures);
    yTrain = y(1:2:end, :);
    yTest  = y(2:2:end, :);
    for i = 1:10
        [_,_,_,weights] = init(xTrain, yTrain);
        weights = pcntrain(xTrain, yTrain, weights, 0.25, 100);
        [m, a] = confmat(xTest, yTest, weights);
        Accs = [Accs, a];
    endfor

    mean(Accs)
endfor

ands = [0,0,0;0,1,0;1,0,0;1,1,1];
x = ands(:,1:2);
y = ands(:,3:3);
[_,_,_,weights] = init(x,y);
weights = pcntrain(x,y,weights,0.15,100);
confmat(x, y, weights);

ors = [0,0,0;0,1,1;1,0,1;1,1,1];
x = ors(:,1:2);
y = ors(:,3:3);
[_,_,_,weights] = init(x,y);
weights = pcntrain(x,y,weights,0.15,100);
confmat(x, y, weights);

pause();
